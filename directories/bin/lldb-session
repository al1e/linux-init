#!/usr/bin/env bash
# Maintained in linux-config.org

# create a lldb debug session unless it already exists.
# the -d to new session says "dont attach to current terminal"
# there is a bug where the splt panes split that of a tmux session in the terminal
# we issue the command from. No idea why or how.
# directory="$(realpath -s "${1:-`pwd`}")"
directory="${1:-`pwd`}"
session="${2:-${directory//[^[:alnum:]]/}}"
if ! TMUX= tmux has-session -t "${session}" &> /dev/null; then
    tmux new-session -d -c "$directory" -s "$session" "lldb && tmux kill-session -t $session"
    lldbPane=$(tmux display-message -p "#{pane_id}")
    tmux splitw -vb -p 80 -t "$lldbPane" "voltron v c 'source list -a \$rip -c 32'"
    srcPane=$(tmux display-message -p "#{pane_id}")
    tmux splitw -h -p 66 -t "$srcPane" "voltron v c 'frame variable' --lexer c"
    localsPane=$(tmux display-message -p "#{pane_id}")
    tmux splitw -h -p 50 -t "$localsPane" "voltron v stack"
    stackPane=$(tmux display-message -p "#{pane_id}")
    tmux splitw -h -p 50 -t "$lldbPane" "voltron v backtrace"
    btPane=$(tmux display-message -p "#{pane_id}")
    tmux select-pane -t "$lldbPane"
fi
echo "$session"
